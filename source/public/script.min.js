if (window.location.href.indexOf("/devices") != -1) {
    function update() {
        const container = document.getElementById('output_tbl');
        let output = "";
        fetch('/api/key', { method: 'GET' })
            .then(res => res.json())
            .then(data => get_req = data)
            .then(() => {
                get_req.forEach((data, index) => {
                    output
                        += "<tr> <th scope='col' class='d-none d-xl-table-cell text-center api-key'>" + data[1] + "</th> <th scope='col'> <div class='input-group align-items-center justify-content-center flex-nowrap'> <div class='form-outline float-start'> <input type='text' class='form-control input-name placeholder-active' value=" + data[0] + "> <div class='form-notch'> <div class='form-notch-leading' style='width: 9px;'></div> <div class='form-notch-middle' style='width: 0px;'></div> <div class='form-notch-trailing'></div> </div> </div> <button type='button' class='btn btn-outline-dark d-table-cell d-xl-none copy-key'> <i class='fas fa-copy'></i> </button> <button type='button' class='btn btn-outline-dark d-table-cell d-xl-none del-key'> <i class='fas fa-trash'></i> </button> </div> </th> <th class='d-none d-xl-table-cell'> <button type='button' class='btn btn-outline-dark copy-key'> <i class='fas fa-copy'></i> </button> <button type='button' class='btn btn-outline-dark del-key'> <i class='fas fa-trash'></i> </button> </th></tr>";
                });
                container.innerHTML = output;
                listeners();
                progress(0);
            })
            .catch(function (error) {
                console.log(error);
            })
    }
    update();

    function index_calc(arg) {
        if (arg % 2 != 0) { arg = (arg / 2) - 0.5; }
        else { arg = (arg / 2); }

        return arg;
    }

    function listeners() {
        document.querySelectorAll('.api-key').forEach((item, index) => {
            item.addEventListener('click', event => {
                api_key = document.querySelectorAll('.api-key')[index_calc(index)].innerText.trim();
                navigator.clipboard.writeText(api_key);
                alert("API key kopiert:\n\n" + api_key.substr(0, 40) + "...");
            })
        })

        document.querySelectorAll('.input-name').forEach((item, index) => {
            item.addEventListener('blur', event => {
                progress(1);
                input_name = document.querySelectorAll('.input-name')[index].value;
                fetch('/api/key?id=' + index + '&value=' + input_name, { method: 'PATCH' })
                    .then(function (response) {
                        progress(0);
                    });
            })
        })

        document.querySelectorAll('.del-key').forEach((item, index) => {
            item.addEventListener('click', event => {
                if (confirm("Sind sie sicher?")) {
                    progress(1);
                    fetch('/api/key?id=' + (index_calc(index)), { method: 'DELETE' })
                        .then(function (response) {
                            update();
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                }
            })
        })

        document.querySelectorAll('.copy-key').forEach((item, index) => {
            item.addEventListener('click', event => {
                api_key = document.querySelectorAll('.api-key')[index_calc(index)].innerText.trim();
                navigator.clipboard.writeText(api_key);
                alert("API key kopiert:\n\n" + api_key.substr(0, 40) + "...");
            })
        })
    }

    document.getElementById('add-key').addEventListener('click', () => {
        progress(1);
        fetch('/api/key', { method: 'POST' })
            .then(function (response) {
                update();
            })
            .catch(function (error) {
                console.log(error);
            });
    });

    /* document.getElementById('refresh-key').addEventListener('click', () => {
        progress(1);
        update();
    }); */

    function progress(status) {
        const container = document.getElementById("loading");
        if (status == 1) {
            click_block.open();
            loading_animation.on();
        } else {
            click_block.close();
            loading_animation.off();
        }
    }
}
/* https://www.cssscript.com/animated-svg-loading-spinner/ */

const click_block = {
    container: null,
    body: null,
    cssClass: 'click_block',
    check: function () {
        if (this.body == null) {
            this.body = document.getElementsByTagName('body')[0];
        }
    },
    open: function () {
        this.check();
        if (!this.isOpen()) {
            this.container = document.createElement('div');
            this.container.setAttribute('id', 'click_block');
            this.body.append(this.container);
            this.body.classList.add(this.cssClass);
        }
        return this;
    },
    close: function () {
        this.check();
        if (this.isOpen()) {
            this.body.classList.remove(this.cssClass);
            this.container.remove();
        }
        return this;
    },
    isOpen: function () {
        this.check();
        return this.body.classList.contains(this.cssClass);
    }
};

const loading_animation = {
    container: document.getElementById("loading"),
    on: function () {
        this.container.style.opacity = "1";
    },
    off: function () {
        this.container.style.opacity = "0";
    }
};