/*

* _dv = devices

*/

function init_dv() {
    update_dv();

    document.getElementById('add-key').addEventListener('click', () => {
        progress_dv(1);
        fetch('/api/key', { method: 'POST' })
            .then(function (response) {
                update_dv();
            })
            .catch(function (error) {
                console.log(error);
            });
    });
}

function timer_dv() {
    update_dv();
}

function update_dv() {
    const container = document.getElementById('output_tbl');
    let output = "";
    fetch('/api/key', { method: 'GET' })
        .then(res => res.json())
        .then(data => get_req = data)
        .then(() => {
            console.log(get_req);
            get_req.forEach((data, index) => {
                output +=
                    `<tr>
                        <th scope="col" class="d-none d-xl-table-cell text-center api-key">
                            <div class="form-outline"> <input class="form-control active" type="text" value="` + data.key + `"
                                    aria-label="readonly api key" readonly="" disabled>
                                <div style="position:absolute; left:0; right:0; top:0; bottom:0;"></div> <label class="form-label"
                                    style="margin-left: 0px;">Readonly</label>
                                <div class="form-notch">
                                    <div class="form-notch-leading" style="width: 9px;"></div>
                                    <div class="form-notch-middle" style="width: 55px;"></div>
                                    <div class="form-notch-trailing"></div>
                                </div>
                            </div>
                        </th>
                        <th scope="col">
                            <div class="input-group align-items-center justify-content-center flex-nowrap">
                                <div class="form-outline float-start"> <input type="text" class="form-control input-name placeholder-active"
                                        value="` + data.name + `">
                                    <div class="form-notch">
                                        <div class="form-notch-leading" style="width: 9px;"></div>
                                        <div class="form-notch-middle" style="width: 0px;"></div>
                                        <div class="form-notch-trailing"></div>
                                    </div>
                                </div> <button type="button" class="btn btn-outline-dark d-table-cell d-xl-none copy-key"> <i
                                        class="fas fa-copy"></i> </button> <button type="button"
                                    class="btn btn-outline-dark d-table-cell d-xl-none del-key"> <i class="fas fa-trash"></i> </button>
                            </div>
                        </th>
                        <th class="d-none d-xl-table-cell"> <button type="button" class="btn btn-outline-dark copy-key"> <i
                                    class="fas fa-copy"></i> </button> <button type="button" class="btn btn-outline-dark del-key"> <i
                                    class="fas fa-trash"></i> </button> </th>
                    </tr>`;
            });
            container.innerHTML = output;
            listeners_dv();
            progress_dv(0);
        })
        .catch(function (error) {
            console.log(error);
        });
}

function index_calc_dv(arg) {
    if (arg % 2 != 0) { arg = (arg / 2) - 0.5; }
    else { arg = (arg / 2); }

    return arg;
}

function listeners_dv() {
    document.querySelectorAll('.api-key > div').forEach((item, index) => {
        api_key = document.querySelectorAll('.api-key input')[index_calc_dv(index)].value.trim();
        item.addEventListener('click', event => {
            navigator.clipboard.writeText(api_key);
            Swal.fire({
                title: 'API key kopiert:',
                text: api_key.substr(0, 40) + "...",
                icon: 'success',
                customClass: {
                    confirmButton: 'btn btn-outline-dark m-2'
                },
                buttonsStyling: false,
            });
        });
    });

    document.querySelectorAll('.input-name').forEach((item, index) => {
        item.addEventListener('blur', event => {
            progress_dv(1);
            input_name = document.querySelectorAll('.input-name')[index].value;
            fetch('/api/key?id=' + index + '&value=' + input_name, { method: 'PATCH' })
                .then(function (response) {
                    progress_dv(0);
                });
        });
    });

    document.querySelectorAll('.del-key').forEach((item, index) => {
        item.addEventListener('click', event => {
            Swal.fire({
                title: 'Sind Sie sich sicher?',
                text: "Sie können dies nicht rückgängig machen!",
                icon: 'warning',
                showCancelButton: true,
                customClass: {
                    confirmButton: 'btn btn-danger m-2',
                    cancelButton: 'btn btn-outline-dark m-2'
                },
                buttonsStyling: false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                cancelButtonText: 'Abbrechen',
                confirmButtonText: 'Löschen'
            }).then((result) => {
                if (result.isConfirmed) {
                    progress_dv(1);
                    fetch('/api/key?id=' + (index_calc_dv(index)), { method: 'DELETE' })
                        .then(function (response) {
                            update_dv();
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                }
            });
        });
    });

    document.querySelectorAll('.copy-key').forEach((item, index) => {
        item.addEventListener('click', event => {
            api_key = document.querySelectorAll('.api-key input')[index_calc_dv(index)].value.trim();
            navigator.clipboard.writeText(api_key);
            Swal.fire({
                title: 'API key kopiert:',
                text: api_key.substr(0, 40) + "...",
                icon: 'success',
                customClass: {
                    confirmButton: 'btn btn-outline-dark m-2'
                },
                buttonsStyling: false,
            });
        });
    });
}

function progress_dv(status) {
    const container = document.getElementById("loading");
    if (status == 1) {
        click_block.open();
        loading_animation.on();
    } else {
        click_block.close();
        loading_animation.off();
    }
}

if (window.location.href.indexOf("/devices") != -1) {
    init_dv();
    setInterval(() => { timer_dv(); }, 30000);
}

function update_fi() {
    const container = document.getElementById('accordionFiles');
    let output = "";
    fetch('/api/tours', { method: 'GET' })
        .then(res => res.json())
        .then(data => get_req = data)
        .then(() => {
            console.log(get_req);
            get_req.forEach((data, index) => {
                output +=
                    `<div class="accordion-item">
                        <h2 class="accordion-header d-flex justify-content-center align-items-center" id="heading_` + index + `">

                            <button type="button" class="btn btn-dark ms-3 p-1 rn-name-btn"
                                style="min-width: 30px; max-height: 30px;">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="accordion-button collapsed flex-grow-1 accordion-btn text-dark" type="button" data-mdb-toggle="collapse"
                                data-mdb-target="#collapse_` + index + `" aria-expanded="false" aria-controls="collapse_` + index + `"
                                style="box-shadow: none;">
                                ` + data.name + " <span class='ms-4 font-monospace'>" + data.file + "</span> " + `
                            </button>

                        </h2>
                        <div id="collapse_` + index + `" class="accordion-collapse collapse" aria-labelledby="heading_` + index + `"
                            data-mdb-parent="#accordionFiles">
                            <div class="accordion-body pt-1">

                                <div class="container-fluid">
                                    <div class="row">

                                        <div class="col-3">
                                            <div class="card">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title text-center">°C</h5>
                                                    <div class="container-fluid m-0 p-0">
                                                        <div class="row">
                                                            <div class="col text-end p-0 px-1">
                                                                Max: <br>
                                                                Min: <br>
                                                                Avg: <br>
                                                            </div>
                                                            <div class="col p-0 px-1 temp_info">
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-3">
                                            <div class="card">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title text-center">Km/h</h5>
                                                    <div class="container-fluid m-0 p-0">
                                                        <div class="row">
                                                            <div class="col text-end p-0 px-1">
                                                                Max: <br>
                                                                Min: <br>
                                                                Avg: <br>
                                                            </div>
                                                            <div class="col p-0 px-1 speed_info">
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                                <span class="badge bg-dark rounded-pill">-</span> <br>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-1"> </div>

                                        <div class="col-4">
                                            <div class="form-outline">
                                                <textarea class="form-control active shadow-3" id="textArea_` + index + `" rows="5"
                                                    style="resize: none;"> ` + data.notes + ` </textarea>
                                                <label class="form-label" for="textArea_` + index + `"
                                                    style="margin-left: 0px;">Notizen</label>
                                                <div class="form-notch">
                                                    <div class="form-notch-leading" style="width: 9px;"></div>
                                                    <div class="form-notch-middle" style="width: 52px;"></div>
                                                    <div class="form-notch-trailing"></div>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="col-1">
                                            <button type="button" class="btn btn-dark mb-2 p-0 open-element-btn"
                                                style="min-width: 30px; min-height: 40px;">
                                                <i class="fas fa-external-link-alt"></i>
                                            </button>
                                            <button type="button" class="btn btn-dark mb-2 p-0 del-element-btn"
                                                style="min-width: 30px; min-height: 40px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button type="button" class="btn btn-dark mb-2 p-0 download-element-btn"
                                                style="min-width: 30px; min-height: 40px;">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = output;
            listeners_fi(get_req);
            /* progress_dv(0); */
        })
        .catch(function (error) {
            console.log(error);
        });
}

/* TODO */

function listeners_fi(data_array) {

    console.log("ev li");

    console.log(data_array);

    document.querySelectorAll('.rn-name-btn').forEach((item, index) => {
        item.addEventListener('click', event => {
            console.log("rn-btn at: " + index);
            /* close all accoridons */
        });
    });

    document.querySelectorAll('.accordion-btn').forEach((item, index) => {
        const speed_info_container = document.querySelectorAll('.speed_info')[index].querySelectorAll('span');
        const temp_info_container = document.querySelectorAll('.temp_info')[index].querySelectorAll('span');

        item.addEventListener('click', event => {
            if (speed_info_container[0].innerHTML == "-") {
                /* progress_dv(1); */ /* shoulnd block => new version only loading symbol */
                fetch('/api/tours/info?file=' + data_array[index].file, { method: 'GET' })
                    .then(res => res.json())
                    .then(data => get_req = data)
                    .then(function (response) {
                        console.log("api req");
                        speed_info_container.forEach((item, index) => {
                            item.innerHTML = get_req[index];
                        });
                        temp_info_container.forEach((item, index) => {
                            item.innerHTML = get_req[index + 3];
                        });
                        /* progress_dv(0); */
                    });
            }
        });
    });

    document.querySelectorAll('.open-element-btn').forEach((item, index) => {
        item.addEventListener('click', event => {
            console.log("open at: " + index);
            window.open(
                "/view/" + data_array[index].file, "_blank");
        });
    });

    document.querySelectorAll('.del-element-btn').forEach((item, index) => {
        item.addEventListener('click', event => {
            console.log("delete at: " + index);
        });
    });

    document.querySelectorAll('.download-element-btn').forEach((item, index) => {
        item.addEventListener('click', event => {
            console.log("download at: " + index);
        });
    });

}

if (window.location.href.indexOf("/files") != -1) {
    update_fi();
}

/*

* inspiration => https://www.cssscript.com/animated-svg-loading-spinner/

*/

const click_block = {
    container: null,
    body: null,
    cssClass: 'click_block',
    check: function () {
        if (this.body == null) {
            this.body = document.getElementsByTagName('body')[0];
        }
    },
    open: function () {
        this.check();
        if (!this.isOpen()) {
            this.container = document.createElement('div');
            this.container.setAttribute('id', 'click_block');
            this.body.append(this.container);
            this.body.classList.add(this.cssClass);
        }
        return this;
    },
    close: function () {
        this.check();
        if (this.isOpen()) {
            this.body.classList.remove(this.cssClass);
            this.container.remove();
        }
        return this;
    },
    isOpen: function () {
        this.check();
        return this.body.classList.contains(this.cssClass);
    }
};

const loading_animation = {
    container: document.getElementById("loading"),
    on: function () {
        this.container.style.opacity = "1";
    },
    off: function () {
        this.container.style.opacity = "0";
    }
};

/*

* set max => infoChart.options.scales.y.max = 20;
* colors for graphs
    #003f5c
    #2f4b7c
    #665191
    #a05195
    #d45087
    #f95d6a
    #ff7c43
    #ffa600
* color for map
    fade => 'blue', 'yellow', 'red'

? multible axes
TODO: better way to display forces
TODO: mobile view

*/

function initMap() {
    const f = chroma.scale(['blue', 'yellow', 'red']);

    const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 18,
        center: new google.maps.LatLng(data_array[1][8], data_array[1][9]),
        mapTypeId: "terrain",
    });

    let max = 0;

    for (i = 1; i < data_array.length - 2; i++) {
        if (max < data_array[i][11]) {
            max = data_array[i][11];
        }
    }

    for (i = 1; i < data_array.length - 2; i++) {
        let pos1 = new google.maps.LatLng(data_array[i][8], data_array[i][9]);
        let pos2 = new google.maps.LatLng(data_array[i + 1][8], data_array[i + 1][9]);

        var check_speed = [10, 50, 100];
        var current_speed = data_array[i][11];

        polyline = new google.maps.Polyline({
            path: [pos1, pos2],
            geodesic: true,
            strokeColor: f(current_speed / max).toString(),
            strokeOpacity: 1.0,
            strokeWeight: 2,
            map: map
        });
    }

    /* bad performence */
    /* for (i = 1; i < data_array.length; i++) {
        marker = new google.maps.Marker({
            position: new google.maps.LatLng(data_array[i][8], data_array[i][9]),
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#996699',
                fillOpacity: 0.5,
                strokeWeight: 0,
                scale: 7
            },
            title: 'kmh: ' + data_array[i][11] + '; alt: ' + data_array[i][10]
        })
    } */
    const ctx1 = document.getElementById('infoChart').getContext('2d');
    const infoChart = new Chart(ctx1, {
        type: 'line',
        responsive: true,
        data: {
            labels: [],
            datasets: [{
                label: 'km/h',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#58508d'
                ],
                pointStyle: 'line',
            },
            {
                label: 'C',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#ff6361'
                ],
                pointStyle: 'line'
            },
            {
                label: 'H',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#ffa600'
                ],
                pointStyle: 'line'
            }],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: 50
                }
            },
            elements: {
                point: {
                    radius: 0
                }
            }
        }
    });

    const ctx2 = document.getElementById('accChart').getContext('2d');
    const accChart = new Chart(ctx2, {
        type: 'line',
        responsive: true,
        data: {
            labels: [],
            datasets: [{
                label: 'x',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#003f5c'
                ],
                pointStyle: 'line'
            },
            {
                label: 'y',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#58508d'
                ],
                pointStyle: 'line'
            },
            {
                label: 'z',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#bc5090'
                ],
                pointStyle: 'line'
            }],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            elements: {
                point: {
                    radius: 0
                }
            }
        }
    });

    const ctx3 = document.getElementById('rotChart').getContext('2d');
    const rotChart = new Chart(ctx3, {
        type: 'line',
        responsive: true,
        data: {
            labels: [],
            datasets: [{
                label: 'x',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#003f5c'
                ],
                pointStyle: 'line'
            },
            {
                label: 'y',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#58508d'
                ],
                pointStyle: 'line'
            },
            {
                label: 'z',
                data: [],
                borderWidth: 1,
                borderColor: [
                    '#bc5090'
                ],
                pointStyle: 'line'
            }],
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            elements: {
                point: {
                    radius: 0
                }
            }
        }
    });

    for (let i = 1; i < data_array.length - 2; i++) {
        infoChart.data.labels[i] = data_array[i][7].substring(0, 5);
        infoChart.data.datasets[0].data[i] = data_array[i][11];
        infoChart.data.datasets[1].data[i] = data_array[i][6];
        infoChart.data.datasets[2].data[i] = data_array[i][10];

        accChart.data.labels[i] = data_array[i][7].substring(0, 5);
        accChart.data.datasets[0].data[i] = data_array[i][0];
        accChart.data.datasets[1].data[i] = data_array[i][1];
        accChart.data.datasets[2].data[i] = data_array[i][2];

        rotChart.data.labels[i] = data_array[i][7].substring(0, 5);
        rotChart.data.datasets[0].data[i] = data_array[i][3];
        rotChart.data.datasets[1].data[i] = data_array[i][4];
        rotChart.data.datasets[2].data[i] = data_array[i][5];
    }
    infoChart.update();
    accChart.update();
    rotChart.update();
}
